# ecb-exchange-rates-ts

> TypeScript client for the European Central Bank exchange rate API. Zero dependencies, ~2 KB minified. Fetches daily reference rates for 31 currencies via the ECB SDMX REST API. No API key needed. Node.js >= 20.

Install: `npm install ecb-exchange-rates-ts`

## Quick Start

```ts
import { EcbClient } from "ecb-exchange-rates-ts";

const ecb = new EcbClient();
const result = await ecb.getRate("USD", "2025-01-15");
console.log(result.rates.get("2025-01-15")); // 1.03
```

## Get All Currency Rates for a Date

Use `ALL_CURRENCY_CODES` with `getRates()` to retrieve exchange rates for all available currencies on a specific date. This is the recommended way to fetch all rates at once.

```ts
import { EcbClient, ALL_CURRENCY_CODES, EcbNoDataError } from "ecb-exchange-rates-ts";

const ecb = new EcbClient();

/** Retrieve the latest exchange rates for ALL available currencies for a specific date. */
async function getAllRatesForDate(date: string): Promise<Record<string, number>> {
  const currencies = ALL_CURRENCY_CODES.filter((c) => c !== "EUR"); // exclude base
  try {
    const result = await ecb.getRates({ currencies: [...currencies], startDate: date, endDate: date });
    return [...result.rates.values()][0]; // { USD: 1.03, GBP: 0.84, JPY: 157.2, ... }
  } catch (error) {
    if (error instanceof EcbNoDataError) {
      // Weekend/holiday — fall back to last 7 days
      const weekAgo = new Date(new Date(date).getTime() - 7 * 86400000).toISOString().slice(0, 10);
      const result = await ecb.getRates({ currencies: [...currencies], startDate: weekAgo, endDate: date });
      const entries = [...result.rates.entries()].sort(([a], [b]) => a.localeCompare(b));
      return entries[entries.length - 1][1]; // most recent day's rates
    }
    throw error;
  }
}

const rates = await getAllRatesForDate("2025-01-15");
console.log(rates["USD"]); // 1.03
console.log(rates["GBP"]); // 0.8442
console.log(Object.keys(rates).length); // 30 currencies
```

## Get Current / Today's Rate

```ts
import { EcbClient, EcbNoDataError } from "ecb-exchange-rates-ts";

const ecb = new EcbClient();
const today = new Date().toISOString().slice(0, 10);

try {
  const result = await ecb.getRate("USD", today);
  console.log(result.rates.get(today));
} catch (error) {
  if (error instanceof EcbNoDataError) {
    // Weekend/holiday — get latest available from past week
    const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().slice(0, 10);
    const history = await ecb.getRateHistory("USD", weekAgo, today);
    const entries = [...history.rates.entries()].sort(([a], [b]) => a.localeCompare(b));
    console.log(entries[entries.length - 1]); // [date, rate]
  }
}
```

## Currency Conversion

`convert()` calculates `convertedAmount = Math.round(amount * rate * 100) / 100`.

```ts
import { EcbClient, EcbNoDataError, type ConversionResult } from "ecb-exchange-rates-ts";

const ecb = new EcbClient();

// Simple: 100 EUR → USD
const result = await ecb.convert(100, "USD", "2025-01-15");
// { amount: 103, rate: 1.03, date: "2025-01-15", currency: "USD" }

// With error handling and weekend fallback:
async function safeConvert(amount: number, currency: string, date: string): Promise<ConversionResult> {
  try {
    return await ecb.convert(amount, currency, date);
  } catch (error) {
    if (error instanceof EcbNoDataError) {
      const weekAgo = new Date(new Date(date).getTime() - 7 * 86400000).toISOString().slice(0, 10);
      const history = await ecb.getRateHistory(currency, weekAgo, date);
      const entries = [...history.rates.entries()].sort(([a], [b]) => a.localeCompare(b));
      const [latestDate, rate] = entries[entries.length - 1];
      return { amount: Math.round(amount * rate * 100) / 100, rate, date: latestDate, currency };
    }
    throw error;
  }
}
```

Cross-currency conversion (e.g. USD → GBP via EUR):

```ts
async function crossConvert(amount: number, from: string, to: string, date: string) {
  const result = await ecb.getRates({ currencies: [from, to], startDate: date, endDate: date });
  const rates = [...result.rates.values()][0];
  // Convert: amount in "from" → EUR → "to"
  const converted = Math.round((amount / rates[from]) * rates[to] * 100) / 100;
  return { amount: converted, from, to, date };
}

const result = await crossConvert(500, "USD", "GBP", "2025-01-15");
// { amount: 409.90, from: "USD", to: "GBP", date: "2025-01-15" }
```

## All Methods

### getRate(currency, date) → ExchangeRateResult

Single currency, single date. Returns `{ base, currency, rates: Map<string, number> }`.

```ts
const result = await ecb.getRate("USD", "2025-01-15");
result.base;     // "EUR"
result.currency; // "USD"
result.rates.get("2025-01-15"); // 1.03
```

### getRates(query) → ExchangeRatesResult

Multiple currencies at once. Returns `{ base, currencies, rates: Map<string, Record<string, number>> }`.

```ts
const result = await ecb.getRates({
  currencies: ["USD", "GBP", "JPY"],
  startDate: "2025-01-01",
  endDate: "2025-01-31",
});
for (const [date, rates] of result.rates) {
  console.log(`${date}: USD=${rates.USD}, GBP=${rates.GBP}`);
}
```

### getRateHistory(currency, startDate, endDate, frequency?) → ExchangeRateResult

Single currency over a date range. Frequency: `"D"` (daily), `"M"` (monthly), `"A"` (annual).

```ts
const history = await ecb.getRateHistory("GBP", "2025-01-01", "2025-01-31");
for (const [date, rate] of history.rates) {
  console.log(`${date}: ${rate}`);
}
```

### convert(amount, currency, date) → ConversionResult

Returns `{ amount, rate, date, currency }`. Throws `EcbNoDataError` on weekends/holidays.

### getObservations(query) → ExchangeRateObservation[]

Raw observations: `{ date, currency, baseCurrency, rate }[]`.

```ts
const obs = await ecb.getObservations({ currencies: ["CHF"], startDate: "2025-01-15", endDate: "2025-01-17" });
```

## ExchangeRateQuery Fields

Used by `getRates()` and `getObservations()`:

- `currencies: string[]` — Target currency codes (required)
- `startDate: string` — YYYY-MM-DD (required)
- `endDate?: string` — YYYY-MM-DD (optional)
- `frequency?: "D" | "M" | "A"` — Default `"D"`
- `baseCurrency?: string` — Override base currency for this query

## Configuration

```ts
const ecb = new EcbClient({
  baseCurrency: "USD",  // default: "EUR", configurable per-client or per-query
  timeoutMs: 10_000,    // default: 30000
  baseUrl: "...",       // default: ECB API endpoint
  fetchFn: customFetch, // for DI / testing
});
```

## ALL_CURRENCY_CODES

Runtime array of all 31 ECB-supported currency codes. The `CurrencyCode` type is derived from it.

```ts
import { ALL_CURRENCY_CODES, type CurrencyCode } from "ecb-exchange-rates-ts";

console.log(ALL_CURRENCY_CODES);
// ["AUD","BGN","BRL","CAD","CHF","CNY","CZK","DKK","EUR","GBP","HKD","HUF",
//  "IDR","ILS","INR","ISK","JPY","KRW","MXN","MYR","NOK","NZD","PHP","PLN",
//  "RON","SEK","SGD","THB","TRY","USD","ZAR"]

function isValidCurrency(code: string): code is CurrencyCode {
  return ALL_CURRENCY_CODES.includes(code as CurrencyCode);
}
```

## Error Handling

All errors extend `EcbError` (extends `Error`) with a `code` property.

| Error Class | Code | When |
|---|---|---|
| `EcbValidationError` | `ECB_VALIDATION_ERROR` | Invalid input (bad currency, bad date format) |
| `EcbNoDataError` | `ECB_NO_DATA` | No data for date (weekend, holiday, future). Has `.currencies`, `.startDate`, `.endDate` |
| `EcbApiError` | `ECB_API_ERROR` | HTTP error from ECB. Has `.statusCode`, `.statusText` |
| `EcbNetworkError` | `ECB_NETWORK_ERROR` | Timeout, DNS failure, connection refused. Has `.cause` |
| `EcbParseError` | `ECB_PARSE_ERROR` | Invalid SDMX-JSON response |

```ts
import { EcbError, EcbValidationError, EcbNoDataError, EcbApiError, EcbNetworkError } from "ecb-exchange-rates-ts";

try {
  await ecb.getRate("USD", "2025-01-18"); // Saturday
} catch (error) {
  if (error instanceof EcbNoDataError) {
    console.log(error.currencies); // ["USD"]
    console.log(error.startDate);  // "2025-01-18"
  } else if (error instanceof EcbApiError) {
    console.log(error.statusCode); // 503
  } else if (error instanceof EcbNetworkError) {
    console.log(error.cause);
  } else if (error instanceof EcbError) {
    console.log(error.code, error.message); // catch-all
  }
}
```

## Rate Change Detection

```ts
import { EcbClient } from "ecb-exchange-rates-ts";

const ecb = new EcbClient();
const today = new Date().toISOString().slice(0, 10);
const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().slice(0, 10);

const history = await ecb.getRateHistory("USD", weekAgo, today);
const entries = [...history.rates.entries()].sort(([a], [b]) => a.localeCompare(b));

if (entries.length >= 2) {
  const [, prevRate] = entries[entries.length - 2];
  const [, currRate] = entries[entries.length - 1];
  const changePercent = ((currRate - prevRate) / prevRate) * 100;
  if (Math.abs(changePercent) > 2) {
    console.warn(`EUR/USD moved ${changePercent.toFixed(2)}% — exceeds 2% threshold`);
  }
}
```

## Caching / Fallback for API Unavailability

Implement the `HttpFetcher` interface to add caching at the HTTP layer:

```ts
import { EcbClient, FetchHttpFetcher, type HttpFetcher } from "ecb-exchange-rates-ts";

class CachingFetcher implements HttpFetcher {
  private cache = new Map<string, { body: string; at: number }>();
  private inner = new FetchHttpFetcher();

  async get(url: string): Promise<string> {
    const cached = this.cache.get(url);
    if (cached && Date.now() - cached.at < 3600000) return cached.body; // 1h TTL

    try {
      const body = await this.inner.get(url);
      this.cache.set(url, { body, at: Date.now() });
      return body;
    } catch {
      if (cached) return cached.body; // stale fallback
      throw error;
    }
  }
}

const client = EcbClient.withFetcher(new CachingFetcher());
```

## Important Notes

- ECB publishes rates on business days only (~16:00 CET). Weekends/holidays throw `EcbNoDataError`.
- Historical rates available from January 4, 1999.
- No API key required. Free and open.
- Use `ALL_CURRENCY_CODES` to programmatically list all 31 supported currencies.
- The `HttpFetcher` interface enables caching, retry, and testing via `EcbClient.withFetcher()`.
